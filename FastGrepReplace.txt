-----------------------------------------------------------------------------
【マクロ名】FastGrepReplace 2.50
【登 録 名】FastGrepReplace250.zip
【制作者名】緒方聡 <satosystems@gmail.com>
【動作環境】秀丸エディタ Ver 8.00 以上
【公 開 日】2003/06/10
【作成方法】ZIP 形式にて圧縮
【 種  別 】フリーウェア
【配布転載】ご自由にどうぞ
-----------------------------------------------------------------------------
【はじめに】
FastGrepReplace はバージョン 2 となって生まれ変わりました。バージョン 1.xx からの改善点は以下のとおりです。

 - 簡単（インターフェイスは以前のままです）
 - より速く（DLL をやめて変換モジュールで作り直しました）
 - より安全に（文字コードの識別力がかなり向上しました）
 - Unicode（UTF-8、UTF-16）に対応
 - Unicode に完全対応（2.50 から）

細かい改善点もいくつかあります。

 - 混在する改行コードに対応
 - ネットワークドライブに対応
 - 置換失敗時のメッセージの強化
 - 秀丸メールで動作しないように制御
 - 持ち出しキットに対応
 - 設定ファイルの不要化
 - Unicode のファイル名、フォルダ名を含むパスに対応（2.50 から）

制限もいくつかあります。

 - 欧文は非対応になりました。

欧文はバージョン 1.xx でサポートしていましたが、バイナリと区別するのがかなり困難なので、安全のため非サポートになりました。このバージョンからは欧文はバイナリと判断される場合があり、その場合は置換はスキップされます。

また、Unicode をサポートしたことと、バイナリファイルの識別力が向上したことで、設定ファイルは必要なくなりました。

【概要】
このマクロは検索結果を置換リストとして、一気に置換を行います。

使い方としては、(1) まず grep、(2) grep 結果上で任意の行を変更、(3) マクロを実行、という流れになります。

置換対象外の行はそのまま残しておいても問題ないですが、あらかじめ削っておいたほうが効率がよいです。

置換対象のファイルがテキストファイルではなかった場合、別のプログラムにロックされている場合、変更する権限がない場合、ファイルが存在しない場合などは、置換は行われず、ログとして結果を報告します。


【インストール】
まずは、1.xx をお使いであればアンインストールしてください。アンインストールの方法は、1.xx のテキストを参照ください。

FastGrepReplaceXXX.zip を展開すると、以下のファイルが作成されます。

・FastGrepReplace.mac             - マクロ本体
・FastGrepReplace.hmf             - 置換用の変換モジュール
・FastGrepReplace.txt             - このテキスト
・FastGrepReplace_libiconv-2.dll  - 文字コード変換ライブラリ（iconv）

上記すべてを秀丸のマクロ用フォルダに移動します。

FastGrepReplace.hmf は変換モジュールですが、動作環境から登録する必要はありません。この変換モジュールはマクロから呼び出されるように設計されているので、登録してメニューから呼び出しても何も行いません。

FastGrepReplace.mac をマクロ登録すると起動に便利です。


【アンインストール】
FastGrepReplace.mac はレジストリを使用していません。アンインストールは変換モジュールの登録を解除して、秀丸のマクロ用フォルダにある以下のファイルを削除します。

・FastGrepReplace.mac
・FastGrepReplace.hmf
・FastGrepReplace.txt
・FastGrepReplace_libiconv-2.dll
・FastGrepReplace.log（あれば）

マクロ登録されている場合は、登録を解除してください。


【使用方法】
1. まずは grep を実行して結果を取得してください。
2. grep 結果を置換します。ファイル名を変更しないように気をつけてください。
3. FastGrepReplace をマクロ起動します。
4. 終了のダイアログが表示されたら置換が終了です。

※ 操作ミスに気をつけてください。
※ grep 結果ファイルは破棄してもかまいません。
※ 必ずバックアップを取ってからご使用ください。


【配布転載】
配布、転載は自由ですが、第三者に通信費、またはメディア代以上のご請求をなさらないようにお願いいたします。


【免責事項】
このマクロを使った事による損害等が万一ありましても、作者は責任を負いかねます。ご使用者の責任のもと御使用下さい。


【サポート】
ご質問やご要望、バグ報告は satosystems@gmail.com にお送りください。
できる限り対応したいと考えています。


【謝辞】
内部・外部ライブラリとして以下を使用させてもらっています。

- WKF (WALL's Kanji Filter)
  http://www.mysticwall.com/software/wkf/download.html

- NKF (Network Kanji Filter)
  http://sourceforge.jp/projects/nkf/

- Libiconv
  http://directory.fsf.org/project/libiconv/

- libiconv-1.13-ja-1.patch.gz 
  http://www2d.biglobe.ne.jp/~msyk/software/libiconv-1.13-ja-patch.html


【ひとこと】
秀丸本体が「grep して置換」という機能をサポートしたため、微妙な感じのマクロになってしまったかと思いましたが、「grep して置換」は置換対象外を選べなかったり、異なる置換を行えないので、まだまだ使用用途があるかなと考えています。欧文を対象にまとめて置換を行いたい場合、組み込みの「grep して置換」をするとよいと思います。


【更新履歴】
・2010/08/01 Version 2.50
Unicode で扱える範囲が CP932 のみになっていた制限を解除。
Unicode を含むパスを正しく処理できるように改善（以前のバージョンではファイルが開けなかった）。
260 文字を超えるパスのファイルに対して適切に処理が行えるようにした（以前のバージョンではファイルが開けなかった）。
UTF-7 の判定処理を見直し（以前のバージョンでは UTF-7 の判定を行っていなかった）。
UTF-7 の書込みに iconv を使用していたが、iconv では Base64 エンコードの最後の - が付与されない不具合があり、自前でエンコードするように対応。
iconv を 1.13 に差し替え。
変換できなかった行数をプログレスダイアログに表示するようにした。
混在する改行コードの扱いの不具合を修正。
サイズ 0 のファイルへの置換は UTF-8（BOM なし）扱いにするようにした（今までは CP932 扱い）。
置換対象行が秀丸内部コード計算で 2048 バイト超過の場合にダイアログを出すようにした（秀丸の grep 結果は 2048 バイトに切りつめられるため）。

・2008/10/13 Version 2.00
変換モジュールで置換するように実装しなおしました（一から書き直しました）。
Unicode をサポートするようにしました。
欧文の判定にはいろいろと問題があるので、非サポートになりました。

・2006/11/30 Version 1.13
置換対象ファイルが欧文（オランダ語、スペイン語等）の場合、置換行が失われてしまう場合がある不具合を改修。

・2006/10/24 Version 1.12
置換対象のファイルが Unicode ファイル、破損ファイル、またはバイナリファイルの場合でも、強制的に置換を行なえるように設定ファイルを追加。

・2005/04/01 Version 1.11
置換対象ファイルの改行コードが CRLF で、対象ファイルに 254 バイトちょうどの行があり、かつその行が置換対象外だった場合に、内部バッファオーバーフローが発生し、対象ファイルにごみがついてしまうバグを修正。

・2005/01/24 Version 1.10
256 バイト超過の行を含むファイルで、その行が置換対象外だった場合に、256 バイト超過の行にごみがついてしまうバグを修正。

・2005/01/07 Version 1.09
存在しない文字コードが含まれている（壊れた）ファイルを置換しないように改良。
なぜ置換されなかったかをユーザに通知するメッセージを追加。

・2004/02/03 Version 1.08
置換対象ファイル名に半角の括弧が含まれていた場合、置換対象外ファイルとして扱うバグを修正。

・2003/10/14 Version 1.07
ファイルの最後が改行で終わっておらず、かつ直前の行よりもバイト数が小さい場合にファイルの最後にごみが付いてしまうバグを修正。
改行コードが CRLF の場合に余計な改行が追加されてしまうバグを修正。
置換結果が置換前と同じ場合は置換せずに高速化。

・2003/09/16 Version 1.06
改行コードが CR または LF のファイルを置換すると、ファイル全体を一行にしてしまうバグを修正。
grep 置換をする複数ファイルの改行コードが異なる場合、ファイルの改行コードを変更してしまう可能性があるバグを修正。

・2003/08/21 Version 1.05
置換対象ファイルに長い行が存在すると秀丸が落ちるバグを修正。
grep 結果をフルパスで出力した際に置換できないバグを修正。

・2003/08/12 Version 1.04
VC++ の提供する関数 strtok を用いて文字分割を行った際に、置換する行が長いと秀丸ごと落ちるバグを修正。

・2003/07/07 Version 1.03
JIS コードのファイルに対応。
置換対象のファイルが Unicode やバイナリの場合は、置換しないように改善。
漢字コード判定に WKF をライブラリとして利用。
置換ロジックを改善して高速化。
存在しないファイルと行数がグレップ結果に存在した場合、空のファイルを作成するバグを修正。
終了時のメッセージを変更。

・2003/07/06 Version 1.02
EUC コードのファイルに対応。
改行コードを勝手に CRLF に変換しないように修正。

・2003/06/29 Version 1.01
置換対象行が最後の一行だった場合にメモリリークが発生していた不具合を修正。
置換対象ファイルが一行しかない場合にメモリリークが発生していた不具合を修正。

・2003/06/10 Version 1.00
安定動作をするようになったので公開。
